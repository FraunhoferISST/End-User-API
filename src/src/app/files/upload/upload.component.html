<div class="flex flex-col items-center justify-start h-full w-full max-w-xl min-w-xl overflow-y-auto px-2">

  <!-- Dynamic Steps Indicator -->
  <ul class="steps mb-8 w-full shrink-0">
    @for (step of steps; track step.name) {
      <li
        class="step"
        [class.step-primary]="step.active || step.completed"
        [attr.data-content]="step.completed ? '✓' : (step.active ? '●' : '')">
        {{ step.name }}
      </li>
    }
  </ul>

  <!-- Step 1: File Selection -->
  @if (currentStep === 1) {
    <div class="card bg-base-200 w-full">
      <div class="card-body">
        <div class="card-title text-2xl mb-4">Select File</div>

        <div class="form-control w-full">
          <label class="label">
            <span class="label-text">Choose a file to upload</span>
          </label>

          <!-- Drop Zone -->
          <div
            class="border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors"
            [class.border-primary]="isDragOver"
            [class.bg-base-300]="isDragOver"
            [class.border-base-content]="!isDragOver"
            [class.opacity-50]="!isDragOver"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            (click)="fileInput.click()">

            @if (!selectedFile) {
              <span class="material-symbols-rounded text-5xl opacity-50 mb-2">cloud_upload</span>
              <p class="font-semibold">Drag & drop your file here</p>
              <p class="text-sm opacity-70">or click to browse</p>
            } @else {
              <span class="material-symbols-rounded text-5xl text-success mb-2">description</span>
              <p class="font-semibold">{{ selectedFile.name }}</p>
              <p class="text-sm opacity-70">{{ formatFileSize(selectedFile.size) }}</p>
            }
          </div>

          <input
            #fileInput
            type="file"
            class="hidden"
            (change)="onFileSelected($event)"/>

          @if (selectedFile) {
            <button
              class="btn btn-outline btn-sm mt-4"
              (click)="clearFile()">
              <span class="material-symbols-rounded">close</span>
              Remove file
            </button>
          }
        </div>
      </div>
    </div>
  }

  <!-- Step 2: Details (Use Case Selection) -->
  @if (currentStep === 2) {
    <div class="card bg-base-200 w-full">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-4">File Details</h2>

        <div class="space-y-4">
          <!-- Use Case Selection -->
          <div class="form-control w-full">
            <label class="label">
              <span class="label-text">Use Case *</span>
            </label>
            <select
              class="select select-bordered w-full"
              [(ngModel)]="metadata.useCase">
              <option value="">Select use case...</option>
              <option value="quality-management">Quality Management</option>
              <option value="supply-chain">Supply Chain</option>
              <option value="traceability">Traceability</option>
              <option value="sustainability">Sustainability</option>
              <option value="demand-forecasting">Demand Forecasting</option>
            </select>
            <label class="label">
              <span class="label-text-alt">Select the use case for this file</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Step 3: Share (Optional) -->
  @if (currentStep === 3) {
    <div class="card bg-base-200 w-full">
      <div class="card-body">
        <div class="card-title text-2xl mb-4">
          <span>Share File</span>
        </div>


        <div class="space-y-4">
          <div class="alert alert-info alert-soft">
            <span class="material-symbols-rounded">info</span>
            <span>This step is optional. You can skip it to save the file without sharing.</span>
          </div>
          <!-- Partner Selection -->
          <div class="form-control w-full">
            <label class="label">
              <span class="label-text">Partner</span>
            </label>
            <select
              class="select select-bordered w-full"
              [(ngModel)]="shareSettings.partner">
              <option value="" disabled selected>Select partner...</option>
              <option value="partner-a">Partner A GmbH</option>
              <option value="partner-b">Partner B AG</option>
              <option value="partner-c">Partner C Ltd.</option>
              <option value="partner-d">Partner D S.A.</option>
            </select>
          </div>

          @if (shareSettings.partner) {
            <div class="alert alert-success alert-soft">
              <span class="material-symbols-rounded">check_circle</span>
              <span>File will be shared with <strong>{{ getPartnerName(shareSettings.partner) }}</strong></span>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Step 4: Overview -->
  @if (currentStep === 4) {
    <div class="card bg-base-200 w-full">
      <div class="card-body">
        @if (!isSubmitted) {
          <h2 class="card-title text-2xl mb-4">Review & {{ willShare ? 'Share' : 'Save' }}</h2>

          <!-- Summary -->
          <div class="bg-base-100 rounded-lg p-4 space-y-3">
            <div class="divider mt-0">File</div>

            <div class="flex justify-between items-center">
              <span class="font-semibold">Selected File:</span>
              <span class="flex items-center gap-2">
                <span class="material-symbols-rounded text-sm">description</span>
                {{ selectedFile?.name }}
              </span>
            </div>

            <div class="flex justify-between">
              <span class="font-semibold">Size:</span>
              <span>{{ formatFileSize(selectedFile?.size || 0) }}</span>
            </div>

            <div class="divider">Details</div>

            <div class="flex justify-between">
              <span class="font-semibold">Use Case:</span>
              <span class="badge badge-info">{{ getUseCaseName(metadata.useCase) }}</span>
            </div>

            <div class="divider">Access Restrictions</div>

            @if (willShare) {
              <div class="flex justify-between">
                <span class="font-semibold">Partner:</span>
                <span class="badge badge-success">{{ getPartnerName(shareSettings.partner) }}</span>
              </div>
            } @else {
              <div class="flex justify-between">
                <span class="font-semibold">Status:</span>
                <span class="badge badge-neutral">Not shared</span>
              </div>
            }
          </div>
        } @else {
          <!-- Success Message -->
          <div class="text-center py-4 flex flex-col justify-center items-center">
            <div class="w-10 h-10 rounded bg-success flex justify-center items-center mb-2">
              <span class="!text-4xl material-symbols-rounded text-success-content">check</span>
            </div>
            <h2 class="text-2xl font-bold text-success mb-2">
              {{ willShare ? 'File Shared!' : 'File Saved!' }}
            </h2>
            <p class="opacity-70">
              @if (willShare) {
                Your file has been uploaded and shared with {{ getPartnerName(shareSettings.partner) }}.
              } @else {
                Your file has been uploaded successfully.
              }
            </p>
          </div>
        }
      </div>
    </div>
  }

  <!-- Navigation Buttons -->
  <div class="flex justify-between w-full mt-8">
    @if (currentStep > 1 && !isSubmitted) {
      <button
        class="btn btn-soft"
        (click)="previousStep()">
        <span class="material-symbols-rounded">arrow_back</span>
        <span>Back</span>
      </button>
    } @else {
      <div></div>
    }

    @if (!isSubmitted) {
      @if (currentStep === 4) {
        <button
          class="btn btn-primary btn-soft"
          [disabled]="isSubmitting"
          (click)="submit()">
          @if (isSubmitting) {
            <span class="loading loading-spinner"></span>
            {{ willShare ? 'Sharing...' : 'Saving...' }}
          } @else {
            <span>{{ willShare ? 'Share' : 'Save' }}</span>
            <span class="material-symbols-rounded">{{ willShare ? 'share' : 'save' }}</span>
          }
        </button>
      } @else if (currentStep === 3) {
        <!-- Special buttons for optional share step -->
        <div class="flex gap-2">
          <button
            class="btn btn-ghost"
            (click)="skipShare()">
            <span>Skip</span>
          </button>
          <button
            class="btn btn-primary btn-soft"
            [disabled]="!canProceed()"
            (click)="nextStep()">
            <span>Next</span>
            <span class="material-symbols-rounded">arrow_forward</span>
          </button>
        </div>
      } @else {
        <button
          class="btn btn-primary btn-soft"
          [disabled]="!canProceed()"
          (click)="nextStep()">
          <span>Next</span>
          <span class="material-symbols-rounded">arrow_forward</span>
        </button>
      }
    } @else {
      <button
        class="btn btn-primary btn-soft"
        (click)="reset()">
        <span class="material-symbols-rounded">add_circle</span>
        <span>Upload Another File</span>
      </button>
    }
  </div>
</div>
